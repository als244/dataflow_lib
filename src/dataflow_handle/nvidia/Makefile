CC = gcc
CFLAGS = -g -fPIC

CUDA_INCLUDE_DIR = /usr/local/cuda/include
CUDA_LIB_DIR = /usr/local/cuda/lib64/stubs
CUDA_LIB_DEPENDS = -lcuda

PROJ_INCLUDE_DIR = ../../../include

PROJ_LIB_DEPENDS = -pthread -lm -ldl

DATAFLOW_HANDLE_INCLUDE_DIR = ../include

OPS_INCLUDE_DIR = ../../ops/include

TABLE_INCLUDE_DIR = ../../table/include
TABLE_OBJ_DIR = ../../table/objs

FINGERPRINT_INCLUDE_DIR = ../../fingerprint/include
FINGERPRINT_OBJ_DIR = ../../fingerprint/objs
FINGERPRINT_LIB_DEPENDS = -lcrypto

SET_NATIVE_OPS_DIR = ../../set_native_ops
SET_NATIVE_OPS_INCLUDE_DIR = ${SET_NATIVE_OPS_DIR}/include
SET_NATIVE_OPS_OBJ_DIR = ${SET_NATIVE_OPS_DIR}/objs

CUDA_DATAFLOW_HANDLE_INCLUDE_DIR = include

CUDA_DATAFLOW_HANDLE_OBJ_DEPENDS = ${TABLE_OBJ_DIR}/table.o
CUDA_DATAFLOW_HANDLE_LIB_DEPENDS = -lcuda

CUDA_DATAFLOW_HANDLE_SRC_DIR = src
CUDA_DATAFLOW_HANDLE_OBJ_DIR = objs

CUDA_DATAFLOW_HANDLE_TEST_DIR = test

DATATYPE_PATH = ../../datatype
DATATYPE_INCLUDE_DIR = ${DATATYPE_PATH}/include
DATATYPE_OBJ_DEPENDS = ${DATATYPE_PATH}/objs/dataflow_datatype.o ${DATATYPE_PATH}/objs/convert_datatype.o ${DATATYPE_PATH}/objs/convert_datatype_avx512.o

OBJS = ${CUDA_DATAFLOW_HANDLE_OBJ_DIR}/cuda_drv.o ${CUDA_DATAFLOW_HANDLE_OBJ_DIR}/cuda_dataflow_handle.o

DEPEND_OBJS = ${TABLE_OBJ_DIR}/table.o

TRANSFORMER_OP_DIR = ../../transformer_ops
TRANSFORMER_OP_OBJ_DEPENDS = ${TRANSFORMER_OP_DIR}/objs/norm_ops.o ${TRANSFORMER_OP_DIR}/objs/attn_misc_ops.o ${TRANSFORMER_OP_DIR}/objs/mlp_misc_ops.o ${TRANSFORMER_OP_DIR}/objs/loss_misc_ops.o
TRANSFORMER_OP_INCLUDE_DIR = ${TRANSFORMER_OP_DIR}/include

TEST_INCLUDE_DIR = ${CUDA_DATAFLOW_HANDLE_TEST_DIR}
TEST_DEPEND_OBJS = ${CUDA_DATAFLOW_HANDLE_TEST_DIR}/create_host_matrix.o ${DATATYPE_OBJ_DEPENDS} ${FINGERPRINT_OBJ_DIR}/fingerprint.o ${SET_NATIVE_OPS_OBJ_DIR}/set_native_op_skeletons.o ${TRANSFORMER_OP_OBJ_DEPENDS}
TEST_LIB_DEPENDS = -lm

EXECS = ${CUDA_DATAFLOW_HANDLE_TEST_DIR}/test_cuda_dataflow_handle



all: ${EXECS} ${OBJS}

${CUDA_DATAFLOW_HANDLE_TEST_DIR}/test_cuda_dataflow_handle: ${CUDA_DATAFLOW_HANDLE_TEST_DIR}/test_cuda_dataflow_handle.c ${OBJS} ${DEPEND_OBJS} ${TEST_DEPEND_OBJS}
	${CC} ${CFLAGS} -I${CUDA_DATAFLOW_HANDLE_INCLUDE_DIR} -I${TABLE_INCLUDE_DIR} -I${SET_NATIVE_OPS_INCLUDE_DIR} -I${FINGERPRINT_INCLUDE_DIR} -I${DATAFLOW_HANDLE_INCLUDE_DIR} -I${OPS_INCLUDE_DIR} -I${TRANSFORMER_OP_INCLUDE_DIR} -I${DATATYPE_INCLUDE_DIR} -I${PROJ_INCLUDE_DIR} -I${CUDA_INCLUDE_DIR} -I${TEST_INCLUDE_DIR} $^ -o $@ ${PROJ_LIB_DEPENDS} ${FINGERPRINT_LIB_DEPENDS} -L${CUDA_LIB_DIR} ${CUDA_LIB_DEPENDS} ${TEST_LIB_DEPENDS}

${CUDA_DATAFLOW_HANDLE_TEST_DIR}/create_host_matrix.o: ${CUDA_DATAFLOW_HANDLE_TEST_DIR}/create_host_matrix.c
	${CC} ${CFLAGS}  -I${CUDA_DATAFLOW_HANDLE_INCLUDE_DIR} -I${TABLE_INCLUDE_DIR} -I${DATAFLOW_HANDLE_INCLUDE_DIR} -I${OPS_INCLUDE_DIR} -I${DATATYPE_INCLUDE_DIR} -I${PROJ_INCLUDE_DIR} -I${CUDA_INCLUDE_DIR} -I${TEST_INCLUDE_DIR} -c -o $@ $<

${CUDA_DATAFLOW_HANDLE_OBJ_DIR}/cuda_dataflow_handle.o: ${CUDA_DATAFLOW_HANDLE_SRC_DIR}/cuda_dataflow_handle.c
	${CC} ${CFLAGS} -I${CUDA_DATAFLOW_HANDLE_INCLUDE_DIR} -I${TABLE_INCLUDE_DIR} -I${DATAFLOW_HANDLE_INCLUDE_DIR} -I${OPS_INCLUDE_DIR} -I${DATATYPE_INCLUDE_DIR} -I${PROJ_INCLUDE_DIR} -I${CUDA_INCLUDE_DIR} -c -o $@ $<

${CUDA_DATAFLOW_HANDLE_OBJ_DIR}/cuda_drv.o: ${CUDA_DATAFLOW_HANDLE_SRC_DIR}/cuda_drv.c
	${CC} ${CFLAGS} -I${CUDA_DATAFLOW_HANDLE_INCLUDE_DIR} -I${PROJ_INCLUDE_DIR} -I${CUDA_INCLUDE_DIR} -c -o $@ $<

clean:
	rm -f ${CUDA_DATAFLOW_HANDLE_TEST_DIR}/*.o ${CUDA_DATAFLOW_HANDLE_OBJ_DIR}/*.o ${EXECS}
