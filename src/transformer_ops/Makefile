CC = gcc
CFLAGS = -g -fPIC


PROJ_INCLUDE_DIR = ../../include
DATATYPE_INCLUDE_DIR = ../datatype/include
OPS_INCLUDE_DIR = ../ops/include
HANDLE_INCLUDE_DIR = ../dataflow_handle/include
TRANSFORMER_OP_INCLUDE_DIR = include
TABLE_INCLUDE_DIR = ../table/include
FINGERPRINT_INCLUDE_DIR = ../fingerprint/include
SET_OPS_INCLUDE_DIR = ../set_ops/include

TRANSFORMER_OP_OBJS = objs/matmul_op.o objs/attention_op.o objs/norm_ops.o objs/attn_misc_ops.o objs/mlp_misc_ops.o objs/loss_misc_ops.o 

TRANSFORMER_OP_LIB = lib/libtransformerops.so
TRANSFORMER_OP_LIB_DEPENDS = -lcrypto -pthread

all: ${TRANSFORMER_OP_LIB} ${TRANSFORMER_OP_OBJS}

${TRANSFORMER_OP_LIB}: ${TRANSFORMER_OP_OBJS}
	${CC} ${CFLAGS} -shared -I${TRANSFORMER_OP_INCLUDE_DIR} -I${PROJ_INCLUDE_DIR} -I${DATATYPE_INCLUDE_DIR} -I${OPS_INCLUDE_DIR} -I${SET_OPS_INCLUDE_DIR} -I${HANDLE_INCLUDE_DIR} -I${FINGERPRINT_INCLUDE_DIR} -I${TABLE_INCLUDE_DIR} $^ -o $@ ${TRANSFORMER_OP_LIB_DEPENDS} 

objs/matmul_op.o: src/matmul_op.c
	${CC} ${CFLAGS} -I${TRANSFORMER_OP_INCLUDE_DIR} -I${PROJ_INCLUDE_DIR} -I${DATATYPE_INCLUDE_DIR} -I${OPS_INCLUDE_DIR} -I${SET_OPS_INCLUDE_DIR} -I${HANDLE_INCLUDE_DIR} -I${FINGERPRINT_INCLUDE_DIR} -I${TABLE_INCLUDE_DIR} -c -o $@ $<

objs/attention_op.o: src/attention_op.c
	${CC} ${CFLAGS} -I${TRANSFORMER_OP_INCLUDE_DIR} -I${PROJ_INCLUDE_DIR} -I${DATATYPE_INCLUDE_DIR} -I${OPS_INCLUDE_DIR} -I${SET_OPS_INCLUDE_DIR} -I${HANDLE_INCLUDE_DIR} -I${FINGERPRINT_INCLUDE_DIR} -I${TABLE_INCLUDE_DIR} -c -o $@ $<

objs/norm_ops.o: src/norm_ops.c
	${CC} ${CFLAGS} -I${TRANSFORMER_OP_INCLUDE_DIR} -I${PROJ_INCLUDE_DIR} -I${DATATYPE_INCLUDE_DIR} -I${OPS_INCLUDE_DIR} -I${SET_OPS_INCLUDE_DIR} -I${HANDLE_INCLUDE_DIR} -I${FINGERPRINT_INCLUDE_DIR} -I${TABLE_INCLUDE_DIR} -c -o $@ $<


objs/attn_misc_ops.o: src/attn_misc_ops.c
	${CC} ${CFLAGS} -I${TRANSFORMER_OP_INCLUDE_DIR} -I${PROJ_INCLUDE_DIR} -I${DATATYPE_INCLUDE_DIR} -I${OPS_INCLUDE_DIR} -I${SET_OPS_INCLUDE_DIR} -I${HANDLE_INCLUDE_DIR} -I${FINGERPRINT_INCLUDE_DIR} -I${TABLE_INCLUDE_DIR} -c -o $@ $<


objs/mlp_misc_ops.o: src/mlp_misc_ops.c
	${CC} ${CFLAGS} -I${TRANSFORMER_OP_INCLUDE_DIR} -I${PROJ_INCLUDE_DIR} -I${DATATYPE_INCLUDE_DIR} -I${OPS_INCLUDE_DIR} -I${SET_OPS_INCLUDE_DIR} -I${HANDLE_INCLUDE_DIR} -I${FINGERPRINT_INCLUDE_DIR} -I${TABLE_INCLUDE_DIR} -c -o $@ $<


objs/loss_misc_ops.o: src/loss_misc_ops.c
	${CC} ${CFLAGS} -I${TRANSFORMER_OP_INCLUDE_DIR} -I${PROJ_INCLUDE_DIR} -I${DATATYPE_INCLUDE_DIR} -I${OPS_INCLUDE_DIR} -I${SET_OPS_INCLUDE_DIR} -I${HANDLE_INCLUDE_DIR} -I${FINGERPRINT_INCLUDE_DIR} -I${TABLE_INCLUDE_DIR} -c -o $@ $<


clean:
	rm -f objs/*.o
